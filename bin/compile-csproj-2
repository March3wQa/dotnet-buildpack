#!/usr/bin/env bash

: ${DOTNET_RUNTIME_VERSION:="2.0.0"}
: ${DOTNET_SDK_VERSION:="2.0.0"}


# Install .NET Core
DOTNET_CACHE_LOCATION=${CACHE_DIR}/dotnet/${DOTNET_SDK_VERSION}
if [ ! -d ${DOTNET_CACHE_LOCATION} ]; then
	rm -rf ${CACHE_DIR}/dotnet/* || true
	mkdir -p ${DOTNET_CACHE_LOCATION}/{sdk,runtime}
	DOTNET_SDK_DOWNLOAD_URL=https://download.microsoft.com/download/1/B/4/1B4DE605-8378-47A5-B01B-2C79D6C55519/dotnet-sdk-$DOTNET_SDK_VERSION-linux-x64.tar.gz
	
	echo "Downloading .NET SDK version ${DOTNET_SDK_VERSION} and runtime version ${DOTNET_RUNTIME_VERSION} from ${DOTNET_SDK_DOWNLOAD_URL}"

	curl --progress-bar ${DOTNET_SDK_DOWNLOAD_URL} | tar xz -C ${DOTNET_CACHE_LOCATION}/sdk
	find ${DOTNET_CACHE_LOCATION}/sdk/sdk/${DOTNET_SDK_VERSION}/runtimes/* -maxdepth 0 ! -name unix ! -name any -exec rm -r {} +
	rm -f ${DOTNET_CACHE_LOCATION}/sdk/sdk/${DOTNET_SDK_VERSION}/nuGetPackagesArchive.lzma

	DOTNET_RUNTIME_DOWNLOAD_URL=https://download.microsoft.com/download/5/F/0/5F0362BD-7D0A-4A9D-9BF9-022C6B15B04D/dotnet-runtime-$DOTNET_RUNTIME_VERSION-linux-x64.tar.gz
	curl --progress-bar ${DOTNET_RUNTIME_DOWNLOAD_URL} | tar xz -C ${DOTNET_CACHE_LOCATION}/runtime
fi
export PATH="${DOTNET_CACHE_LOCATION}/sdk:$PATH"
cp -r ${DOTNET_CACHE_LOCATION}/runtime ${BUILD_DIR}/dotnet
cat <<EOF >$BUILD_DIR/.profile.d/000_dotnet.sh
export PATH="\$HOME/dotnet:\$PATH"
EOF

export NUGET_PACKAGES="${CACHE_DIR}/nuget/cache"

# run on  each project we need to publish, build it and deploy it
 while IFS=';' read -ra ADDR; do
      for i in "${ADDR[@]}"; do
			PROJECT_DIR=${SRC_DIR}/$i
			PROJECT_DIR_NAME=$(basename $PROJECT_DIR)
			PROJECT_FILE=${SRC_DIR}/$i/$PROJECT_DIR_NAME.csproj
			
			echo "Restoring packages for ${PROJECT_DIR_NAME}"
			dotnet restore --runtime ubuntu.14.04-x64 ${PROJECT_FILE}

			echo "Publishing ${PROJECT_DIR_NAME}"
			dotnet publish ${PROJECT_FILE} --output ${BUILD_DIR}/heroku_output/${PROJECT_DIR_NAME} --runtime ubuntu.14.04-x64 --configuration Release

			echo "Publish of '$PROJECT_DIR_NAME' successed"
      done
 done <<< "$PROJECTS"