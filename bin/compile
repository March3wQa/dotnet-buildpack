#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

if [ $STACK != "cedar-14" ]; then
	echo "Stack ${STACK} not supported" && exit 1
fi

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

# This is where the buildpack is stored
BUILDPACK_DIR=`cd $(dirname $0); cd ..; pwd`

source $BUILDPACK_DIR/bin/util

export_env_dir ${ENV_DIR}

# decide which SDK to pick - CSPROJ or JSON
if [ -n "$( find $1 -maxdepth 5 -iname project.json )" ]; then
  echo "'Project.json' project type detected"
  source $BUILDPACK_DIR/bin/compile-projectjson
else
  echo "'Csproj' project type detected"
  source $BUILDPACK_DIR/bin/compile-csproj
fi

 # copy procfile
mkdir -p ${BUILD_DIR}/.profile.d
cp -n ${BUILDPACK_DIR}/.profile.d/* ${BUILD_DIR}/.profile.d/

if [ -e ${SRC_DIR}/Procfile ]; then
	cp ${SRC_DIR}/Procfile ${BUILD_DIR}
else
	echo "'Procfile' was not found!"
fi

# executa post compilations
if [ -f $SRC_DIR/.post_compile ]; then
	(cd $SRC_DIR && source .post_compile)
else
	echo "File $SRC_DIR/.post_compile not found"	
fi